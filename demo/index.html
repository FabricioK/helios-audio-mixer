<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Audio Mixer Test Page</title>

	<style>
		* { font-family: sans-serif; }

		h4 {
			display: inline-block;
			width: 5em;
			margin: 0;
			margin-right: 1em;
		}

		.slider {
			display: inline-block;
			position: relative;
			width: 100px;
			margin: 10px 0;
			background: #eee;
			height: 1em;
		}
		.playhead {
			position: absolute;
			width: 1px;
			height: 100%;
			background: black;
		}

		td {
			/* border-left: 1px solid #ddd; */
			/* border-right: 1px solid #ddd; */
			border-top: none;
			border-bottom: none;
			padding: 0.5em;
			border-collapse: separate;
		}

		button {
			display: inline-block;
			padding: 0.4em 0.6em;
			background: none;
			border: 1px solid black;
			border-radius: 2px;
		}
		button:hover {
			background: black;
			color: white;
			cursor: pointer;
		}
		button.active {
			background: grey;
			color: white;
		}

		select { width: 100%; }
	</style>
</head>
<body>


	<h2>Helios Audio Mixer Test Page</h2>

	Web Audio: <span id="webaudio"></span> <br>
	<!-- Audio type: <span id="audioType"></span> -->

	<br>


	<table>

		<tr>

			<td><h4>Create</h4></td>

			<td>
				<button onclick="createTrack1()"> create </button>
				<button onclick="Mixer.removeTrack('track1')">remove</button>
			</td>
			<td>
				<button onclick="createFluorescent()"> create</button>
				<button onclick="Mixer.removeTrack('track2')">remove</button>
			</td>
			<td>
				<button onclick="createtrack3()"> create</button>
				<button onclick="Mixer.removeTrack('track3')">remove</button>
			</td>

		</tr><tr>

		<td><h4>Source</h4></td>

			<td>
				<select name="track1-source" id="track1-source">
					<option value="dm-tw-bass">dm-tw-bass</option>
					<option value="Drone_1_norm">Drone_1_norm</option>
				</select>
			</td>
			<td>
				<select name="track2-source" id="track2-source">
					<option value="dm-tw-buzzlo">dm-tw-buzzlo</option>
					<option value="Helicopter_Interior">Helicopter_Interior</option>
				</select>
			</td>
			<td>
				<select name="track3-source" id="track3-source">
					<option value="dm-tw-woosh">dm-tw-woosh</option>
					<option value="SilverBottle">SilverBottle</option>
				</select>
			</td>
		</tr><tr>

		<td><h4>Source Mode</h4></td>

			<td>
				<select name="source-mode" id="track1-source-mode">
					<option value="buffer">Buffer</option>
					<option value="element">Element</option>
				</select>
			</td>
			<td>
				<select name="source-mode" id="track2-source-mode">
					<option value="buffer">Buffer</option>
					<option value="element">Element</option>
				</select>
			</td>
			<td>
				<select name="source-mode" id="track3-source-mode">
					<option value="buffer">Buffer</option>
					<option value="element">Element</option>
				</select>
			</td>

		</tr><tr>

			<td><h4>Gain</h4></td>

			<td><input name="track1gain" id="track1gain" type="range" min="0" max="100" value="100"></td>
			<td><input name="track2gain" id="track2gain" type="range" min="0" max="100" value="10"></td>
			<td><input name="track3gain" id="track3gain" type="range" min="0" max="100" value="50"></td>

		</tr><tr>

			<td><h4>Tween Gain</h4></td>

			<td>
				<button onclick="if(Mixer.getTrack('track1')) Mixer.getTrack('track1').tweenGain(0,1000)">Out</button>
				<button onclick="if(Mixer.getTrack('track1')) Mixer.getTrack('track1').tweenGain(1,1000,function(){ console.log('Drone in callback')})">In</button>
			</td>

		</tr><tr>

			<td><h4>Pan</h4></td>

			<td><input name="track1pan" id="track1pan" type="range" min="0" max="360" value="0"></td>
			<td><input name="track2pan" id="track2pan" type="range" min="0" max="360" value="0"></td>
			<td><input name="track3pan" id="track3pan" type="range" min="0" max="360" value="0"></td>

		</tr><tr>

			<td><h4>Tween Pan</h4> </td>

			<td><button onclick="if(Mixer.getTrack('track1')) Mixer.getTrack('track1').tweenPan(720, 6000)">Drone</button></td>
			<!-- <td><button onclick="if(Mixer.getTrack('track2')) Mixer.getTrack('track2').play()">track2</button> </td> -->
			<!-- <td><button onclick="if(Mixer.getTrack('track3')) Mixer.getTrack('track3').play()">track3</button> </td> -->

		</tr><tr>

			<td><h4>Pan Position</h4></td>

			<td><canvas id="track1panCanvas" width="100" height="100"></canvas></td>
			<td><canvas id="track2panCanvas" width="100" height="100"></canvas></td>
			<td><canvas id="track3panCanvas" width="100" height="100"></canvas></td>

		</tr><tr>

			<td><h4>Progress</h4></td>

			<td>
				<div class="slider" id="track1slider"> <div class="playhead" id="track1playhead"></div></div> <br>
				<div id="track1time">00:00/00:00</div>
			</td>
			<td>
				<div class="slider" id="track2slider"> <div class="playhead" id="track2playhead"></div></div> <br>
				<div id="track2time">00:00/00:00</div>
			</td>
			<td>
				<div class="slider" id="track3slider"> <div class="playhead" id="track3playhead"></div></div> <br>
				<div id="track3time">00:00/00:00</div>
			</td>

		</tr><!-- <tr>

			<td><h4>Set Time</h4></td>

			<td><input type="text" id="track1setTime"></td>


		</tr> --><tr>

			<td><h4>Play</h4> </td>

			<td><button onclick="if(Mixer.getTrack('track1')) Mixer.getTrack('track1').play()">Drone</button></td>
			<td><button onclick="if(Mixer.getTrack('track2')) Mixer.getTrack('track2').play()">track2</button></td>
			<td><button onclick="if(Mixer.getTrack('track3')) Mixer.getTrack('track3').play()">track3</button></td>

		</tr><tr>

			<td><h4>Pause</h4> </td>

			<td><button onclick="if(Mixer.getTrack('track1')) Mixer.getTrack('track1').pause()">Drone</button></td>
			<td><button onclick="if(Mixer.getTrack('track2')) Mixer.getTrack('track2').pause()">track2</button></td>
			<td><button onclick="if(Mixer.getTrack('track3')) Mixer.getTrack('track3').pause()">track3</button></td>

		</tr><tr>

			<td><h4>Stop</h4> </td>

			<td><button onclick="if(Mixer.getTrack('track1')) Mixer.getTrack('track1').stop()">Drone</button></td>
			<td><button onclick="if(Mixer.getTrack('track2')) Mixer.getTrack('track2').stop()">track2</button></td>
			<td><button onclick="if(Mixer.getTrack('track3')) Mixer.getTrack('track3').stop()">track3</button></td>


	</table>


	<br><br><br>


	<h4>Mixer</h4>

	<button onclick="Mixer.pause()">Pause All ||</button>
	<button onclick="Mixer.play()">Play All &gt;</button>
	<button onclick="Mixer.stop()">Stop All</button>

	<button id="mix-mute" onclick="mute()">Toggle Mute</button>

	<input name="mastergain" id="mastergain" type="range" min="0" max="100" value="100">


	<script src="js/bowser.min.js"></script>
	<script src="js/tween.min.js"></script>
	<script src="js/frameRunner.js"></script>
	<script src="../helios-audio-mixer.js"></script>

	<script>

		var Mixer = new heliosAudioMixer();

		if(window.location.hash === '#html5' || ! Mixer.detect.webAudio) {
			console.log('HTML5 mode')
			Mixer.detect.webAudio = false;

			Mixer.createTrack('track1', {});
			Mixer.createTrack('track2', {});
			Mixer.createTrack('track3', {});
		}

		mute()

		Mixer.setLogLvl(2)

		frameRunner.start();
		frameRunner.add('updateMixerTween','everyFrame',Mixer.updateTween);

		console.log('Feature detection: %O', Mixer.detect)

		if(Mixer.detect.webAudio) document.getElementById('webaudio').innerHTML = "YES";
		else 					  document.getElementById('webaudio').innerHTML = "NO";

		// document.getElementById('audioType').innerHTML = Mixer.detect.audioType;


		function mute(){
			console.log('mute')
			if(Mixer.muted){
				Mixer.unmute()
				document.getElementById('mix-mute').classList.remove('active')
			} else{
				Mixer.mute()
				document.getElementById('mix-mute').classList.add('active')
			}
		}

		// ********************************************************
		// Setup and Events

		var track1panCanvas = document.getElementById('track1panCanvas');
		var track2panCanvas = document.getElementById('track2panCanvas');
		var track3panCanvas = document.getElementById('track3panCanvas');

		function updatePanDisplay(trackName,canvas){
			// Canvas
			var x = 50 + (Mixer.getTrack(trackName).options.panX * 20);
			var y = 50 + (-Mixer.getTrack(trackName).options.panY * 20);

			var ctx = canvas.getContext('2d');

			ctx.clearRect(0,0, 100,100);

			ctx.arc(50,50, 2, 0,2*Math.PI);
			ctx.fill()

			ctx.fillRect(x-5,y-5,10,10)
		}

		function createTrack1(){

			var track1 = Mixer.createTrack('track1', {
				source: 'audio/' + document.getElementById('track1-source').value,
				sourceMode: document.getElementById('track1-source-mode').value,
				gain: 1.0,
				looping: true,
				autoplay: true
			})

			track1.on('ended', function(){
				console.log('track1 ended event')
			})

			track1.on('pan',function(){
				updatePanDisplay('track1',track1panCanvas)
				document.getElementById('track1pan').value = track1.options.pan
			})

			track1.on('gain',function(){
				document.getElementById('track1gain').value = track1.options.gain*100
			})

			var timeEl = document.getElementById('track1time')
			,	playheadEl = document.getElementById('track1playhead')

			track1.on('play',function(){
				frameRunner.add('drone_timeUpdate','everyFrame', function(){
					updateTime( track1, timeEl, playheadEl )
				})
			})

			track1.on('pause',function(){
				frameRunner.remove('drone_timeUpdate','everyFrame')
			})



			var updateTime = function( track, timeEl, playheadEl ){
				if( !track ) return
				timeEl.innerHTML = track1.formattedTime();
				playheadEl.style.left = ( track1.currentTime() / track1.duration() ) * 100 + 'px';
			}

			frameRunner.add('updateTime','everyFrame',updateTime)




		}

		// ~~~

		function createFluorescent(){

			Mixer.createTrack('track2', {
				source: 'audio/' + document.getElementById('track2-source').value,
				sourceMode: document.getElementById('track2-source-mode').value,
				autoplay: true,
				gain: 1,
				pan: 'left'
			})

			Mixer.getTrack('track2').on('pan',function(){
				updatePanDisplay('track2',track2panCanvas)
				document.getElementById('track2pan').value = Mixer.getTrack('track2').options.pan
			})

			Mixer.getTrack('track2').on('gain',function(){
				document.getElementById('track2gain').value = Mixer.getTrack('track2').options.gain*100
			})

		}



		function createtrack3(){
			Mixer.createTrack('track3', {
				source: 'audio/' + document.getElementById('track3-source').value,
				sourceMode: document.getElementById('track3-source-mode').value,
				gain: 0.5,
				pan: 0,
				// nodes: [ 'compressor' ]
			})

			Mixer.getTrack('track3').on('load',function(){
				console.log('TRACK 3 LOADED CALLBACK')
			})

			Mixer.getTrack('track3').on('pan',function(){
				updatePanDisplay('track3',track3panCanvas)
				document.getElementById('track3pan').value = Mixer.getTrack('track3').options.pan
			})

			Mixer.getTrack('track3').on('gain',function(){
				document.getElementById('track3gain').value = Mixer.getTrack('track3').options.gain*100
			})
		}

		// ~~~



		// ********************************************************
		// Gain Sliders

		document.getElementById('track1gain').addEventListener('change',function(e){
			console.log('CHANGE')
			if(Mixer.getTrack('track1')) Mixer.getTrack('track1').gain(e.target.value/100)
		},false)

		document.getElementById('track2gain').addEventListener('change',function(e){
			if(Mixer.getTrack('track2')) Mixer.getTrack('track2').gain(e.target.value/100)
		},false)

		document.getElementById('track3gain').addEventListener('change',function(e){
			if(Mixer.getTrack('track3')) Mixer.getTrack('track3').gain(e.target.value/100)
		},false)

		document.getElementById('mastergain').addEventListener('change',function(e){
			Mixer.gain(e.target.value/100)
		},false)



		// ********************************************************
		// Pan Sliders

		document.getElementById('track1pan').addEventListener('change',function(e){
			if(Mixer.getTrack('track1')) Mixer.getTrack('track1').pan( e.target.valueAsNumber );
		},false)

		document.getElementById('track2pan').addEventListener('change',function(e){
			if(Mixer.getTrack('track2')) Mixer.getTrack('track2').pan( e.target.valueAsNumber )
		},false)

		document.getElementById('track3pan').addEventListener('change',function(e){
			if(Mixer.getTrack('track3')) Mixer.getTrack('track3').pan( e.target.valueAsNumber )
		},false)


	</script>

</body>
</html>