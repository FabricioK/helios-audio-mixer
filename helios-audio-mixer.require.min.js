define(["tween"],function(){var Mix,Track,Detect,debug=1;Detect={audioElement:!!document.createElement("audio").canPlayType,videoElement:!!document.createElement("video").canPlayType,webAudio:!(!window.webkitAudioContext&&!window.AudioContext),nodes:function(){var context=window.AudioContext?new AudioContext:new webkitAudioContext;return{gain:!("function"!=typeof context.createGain),gainNode:!("function"!=typeof context.createGainNode),panner:!("function"!=typeof context.createPanner),convolver:!("function"!=typeof context.createConvolver),delay:!("function"!=typeof context.createDelay),delayNode:!("function"!=typeof context.createDelayNode),compressor:!("function"!=typeof context.createDynamicsCompressor)}}(),audioType:function(){var el=document.createElement("audio"),extension=!1;return extension=el.canPlayType&&el.canPlayType('audio/mp4; codecs="mp4a.40.2"').replace(/no/,"")?".m4a":el.canPlayType&&el.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")?".ogg":el.canPlayType&&el.canPlayType("audio/mpeg;").replace(/no/,"")?".mp3":!1,el=null,extension}(),videoType:function(){var el=document.createElement("video"),extension=!1;return extension=el.canPlayType&&el.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/no/,"")?".webm":el.canPlayType&&el.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"').replace(/no/,"")?".mp4":el.canPlayType&&el.canPlayType('video/ogg; codecs="theora"').replace(/no/,"")?".ogv":!1,el=null,extension}(),browser:function(){return"undefined"!=typeof bowser?bowser:{firefox:navigator.userAgent.match(/Firefox/g)?!0:!1,android:navigator.userAgent.match(/Android/g)?!0:!1,msie:navigator.userAgent.match(/MSIE/g)?!0:!1,ios:navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1,version:!1}}(),tween:!!TWEEN};var constrain=function(val,min,max){return min>val?min:val>max?max:val},log=function(msg,lvl){debug>=lvl&&console.log(msg)},timeFormat=function(seconds){var m=Math.floor(seconds/60)<10?"0"+Math.floor(seconds/60):Math.floor(seconds/60),s=Math.floor(seconds-60*m)<10?"0"+Math.floor(seconds-60*m):Math.floor(seconds-60*m);return m+":"+s},BaseClass=function(){};BaseClass.prototype.on=function(type,callback){this.events[type]=this.events[type]||[],this.events[type].push(callback)},BaseClass.prototype.off=function(type){this.events[type]=[]},BaseClass.prototype.trigger=function(type){if(this.events[type]){log(arguments,2);for(var args=Array.prototype.slice.call(arguments,1),i=0,l=this.events[type].length;l>i;i++)"function"==typeof this.events[type][i]&&this.events[type][i].apply(this,args)}},BaseClass.prototype.extend=function(){for(var output={},args=arguments,l=args.length,i=0;l>i;i++)for(var key in args[i])args[i].hasOwnProperty(key)&&(output[key]=args[i][key]);return output};var Mix=function(opts){log("[Mixer] Loaded",2);var defaults={html5:!1,tracks:[]};this.options=this.extend.call(this,defaults,opts||{}),console.log("this.options: %O",this.options),this.tracks=[],this.groups={},this.lookup={},this.playing=!1,this.muted=!1,this.gain=1,this.events={},this.context=null,this.detect=Detect,("Firefox"===Detect.browser.name||Detect.browser.ios===!0&&Detect.browser.version>6||Detect.browser.ios===!0&&!Detect.browser.version||this.options.html5)&&(Detect.webAudio=!1),Detect.webAudio===!0?(log("[Mixer] Web Audio Mode",1),this.context="function"==typeof AudioContext?new AudioContext:new webkitAudioContext):log("[Mixer] HTML5 Mode",1)};Mix.prototype=new BaseClass,Mix.prototype.createTrack=function(name,opts){var track;if(Detect.webAudio===!0){if(this.lookup[name])return void console.warn('[Mixer] A track called "%s" already exists',name);track=new Track(name,opts,this),this.tracks.push(track),this.lookup[name]=track}else track=this.lookup[name],track?(track.options=track.extend(track,track.defaults,opts||{}),opts.source&&track.loadDOM(opts.source)):(track=new Track(name,opts,this),this.tracks.push(track),this.lookup[name]=track);return track},Mix.prototype.removeTrack=function(name){var self=this,track=self.lookup[name];if(!track)return void console.warn('[Mixer] can’t remove "%s", it doesn’t exist',name);if(Detect.webAudio===!0){var doIt=function(){track.pause();for(var rest,arr=self.tracks,total=arr.length,i=0;total>i;i++)arr[i]&&arr[i].name==name&&(rest=arr.slice(i+1||total),arr.length=0>i?total+i:i,arr.push.apply(arr,rest));track.trigger("remove"),track.events=[],track=null,delete self.lookup[name],log('[Mixer] Removed track "'+name+'"',1)};Detect.tween?track.tweenGain(0,100,doIt):doIt()}else track.pause(),track.element.src=track.source=null,track.ready=!1,track.loaded=!1},Mix.prototype.removeTracks=function(group){var tracks=this.getTracks(group);if(tracks)for(var i=0;i<tracks.length;i++)this.removeTrack(tracks[i].name)},Mix.prototype.getTrack=function(name){return this.lookup[name]||!1},Mix.prototype.getTracks=function(group){return"undefined"==typeof group||"*"===group?this.tracks:this.groups[group]?this.groups[group]:void console.warn('[Mixer] Can’t get group "%s", it doesn’t exist.',group)},Mix.prototype.removeAll=function(group){var tracks=this.getTracks(group),total=tracks.length;"undefined"==typeof group?(this.playing=!1,log("[Mixer] Removing all "+total+" track(s)",1)):log("[Mixer] Removing "+total+" track(s) from group "+group,1);for(var i=0;total>i;i++)this.removeTrack(tracks[i].name)},Mix.prototype.pause=function(group){var tracks=this.getTracks(group),total=tracks.length;log("[Mixer] Pausing "+total+" track(s) ||",1),this.playing=!1;for(var i=0;total>i;i++)tracks[i].ready&&tracks[i].pause()},Mix.prototype.play=function(group){var tracks=this.getTracks(group),total=tracks.length;log("[Mixer] Playing "+total+" track(s) >",1),this.playing=!0;for(var i=0;total>i;i++)tracks[i].ready&&tracks[i].play()},Mix.prototype.stop=function(group){var tracks=this.getTracks(group),total=tracks.length;log("[Mixer] Stopping "+total+" track(s) .",1),this.playing=!0;for(var i=0;total>i;i++)tracks[i].ready&&tracks[i].stop()},Mix.prototype.mute=function(){if(this.muted===!0)return console.log("this.muted === true, unmuting"),void this.unmute();var total=this.tracks.length;log("[Mixer] Muting all "+total+" tracks",1),this.playing=!1,this.muted=!0;for(var i=0;total>i;i++)this.tracks[i].mute();for(var i=0;i<this.tracks.length;i++)this.tracks[i].playing&&(this.playing=!0)},Mix.prototype.unmute=function(){var total=this.tracks.length;log("[Mixer] Unmuting all "+total+" tracks",1),this.playing=!0,this.muted=!1;for(var i=0;total>i;i++)this.tracks[i].unmute()},Mix.prototype.setGain=function(masterGain){if("undefined"!=typeof masterGain){var total=this.tracks.length;this.gain=masterGain;for(var i=0;total>i;i++)this.tracks[i].gain(this.tracks[i].gain())}return this.gain},Mix.prototype.updateTween=function(){TWEEN.update()},Mix.prototype.setLogLvl=function(lvl){debug=constrain(lvl,0,2)};var Group=function(name,tracks){this.tracks=tracks||[],this.events={}};Group.prototype=new BaseClass,Group.prototype.play=function(){for(var i=0;i<this.tracks.length;i++)this.tracks[i].play();this.trigger("play")},Group.prototype.pause=function(){for(var i=0;i<this.tracks.length;i++)this.tracks[i].pause();this.trigger("play")},Group.prototype.stop=function(){for(var i=0;i<this.tracks.length;i++)this.tracks[i].stop();this.trigger("stop")},Group.prototype.mute=function(){for(var i=0;i<this.tracks.length;i++)this.tracks[i].mute();this.trigger("mute")},Group.prototype.unmute=function(){for(var i=0;i<this.tracks.length;i++)this.tracks[i].unmute();this.trigger("unmute")},Group.prototype.pan=function(angle){for(var i=0;i<this.tracks.length;i++)this.tracks[i].pan(angle);this.trigger("pan")},Group.prototype.tweenPan=function(angle,duration,callback){for(var i=0;i<this.tracks.length;i++)0===i?this.tracks[i].tweenPan(angle,duration,callback):this.tracks[i].tweenPan(angle,duration);this.trigger("tweenPan")},Group.prototype.gain=function(setTo){for(var i=0;i<this.tracks.length;i++)this.tracks[i].gain(setTo);this.trigger("gain")},Group.prototype.tweenGain=function(setTo,duration,callback){for(var i=0;i<this.tracks.length;i++)0===i?this.tracks[i].tweenGain(setTo,duration,callback):this.tracks[i].tweenGain(setTo,duration);this.trigger("tweenGain")};var Track=function(name,opts,mix){this.defaults={source:!1,group:!1,nodes:[],gain:0,gainCache:0,pan:0,panX:0,panY:0,panZ:0,start:0,cachedTime:0,startTime:0,looping:!1,autoplay:!0,onendtimer:null,muted:!1},this.options=this.extend.call(this,this.defaults,opts||{}),this.options.source=this.options.source+Detect.audioType,this.name=name,this.loaded=!1,this.ready=!1,this.playing=!1,this.events={},this.nodes={},this.mix=mix,this.element=null,this.source=null;var self=this;return this.options.source?(log('[Mixer] Creating track "'+name,1),log(this.options,2),this.options.group&&(this.mix.groups[this.options.group]||(this.mix.groups[this.options.group]=new Group),this.mix.groups[this.options.group].tracks.push(this)),void(Detect.webAudio===!0?this.loadBuffer(this.options.source):(console.log("creating element"),self.element=document.createElement("audio"),self.element.addEventListener("canplaythrough",function(){log('[Mixer] "'+self.name+'" canplaythrough',2),self.loaded=!0,self.ready=!0,self.trigger("load",self),self.options.autoplay&&self.play()},!1),self.element.addEventListener("ended",function(){self.options.looping?(log("Track "+self.name+" looping",2),self.element.currentTime=0,self.element.play()):self.mix.removeTrack(self.name)},!1),self.options.autoplay&&this.loadDOM(this.options.source)))):void console.warn('[Mixer] Can’t create track "'+name+'" without a source')};return Track.prototype=new BaseClass,Track.prototype.loadDOM=function(source){if(source){log('[Mixer] Track "'+this.name+'" load DOM: "'+source+Detect.audioType+'"',2);var self=this;self.ready=!1,self.element.src=source+Detect.audioType,self.element.load(),self.source=self.element,Detect.Firefox===!0&&self.element.play()}},Track.prototype.loadBuffer=function(source){if(source){var self=this,request=new XMLHttpRequest;request.open("GET",source,!0),request.responseType="arraybuffer",log('[Mixer] Track "'+this.name+'" load Buffer "'+source+'"...',2),request.onload=function(){log('[Mixer] "'+self.name+'" loaded "'+source+'"',2),self.options.audioData=request.response,self.loaded=!0,self.options.autoplay&&self.play(),self.trigger("load")},request.send()}},Track.prototype.addNode=function(nodeType){var self=this;return self.nodes.lastnode||(self.nodes.lastnode=self.source),Detect.nodes[nodeType]?("gain"===nodeType?(self.nodes.gain=Detect.nodes.gainNode?self.mix.context.createGainNode():self.mix.context.createGain(),self.nodes.lastnode.connect(self.nodes.gain),self.nodes.lastnode=self.nodes.gain):"panner"===nodeType?(Detect.nodes.gainNode?(self.nodes.panner=self.mix.context.createPanner(),self.nodes.panner.panningModel=webkitAudioPannerNode.EQUALPOWER):(self.nodes.panner=self.mix.context.createPanner(),self.nodes.panner.panningModel="equalpower",self.nodes.panner.panningModel="HRTF"),self.nodes.lastnode.connect(self.nodes.panner),self.nodes.lastnode=self.nodes.panner):"convolver"===nodeType?self.nodes.convolver=self.mix.context.createConvolver():"compressor"===nodeType?(self.nodes.compressor=self.mix.context.createDynamicsCompressor(),self.nodes.lastnode.connect(self.nodes.compressor),self.nodes.lastnode=self.nodes.compressor):"delay"===nodeType&&(self.nodes.delay=Detect.nodes.delayNode?self.mix.context.createDelayNode():self.mix.context.createDelay(),self.nodes.delay.delayTime=0,self.nodes.lastnode.connect(self.nodes.delay),self.nodes.lastnode=self.nodes.delay),log("+ addNode "+nodeType,2),self):self},Track.prototype.play=function(){var self=this;if(self.loaded&&self.playing!==!0){if(self.playing=!0,Detect.webAudio){if(self.source=self.options.sourceBuffer=null,self.nodes={},"function"==typeof self.mix.context.createGainNode){self.source=self.mix.context.createBufferSource(),self.sourceBuffer=self.mix.context.createBuffer(self.options.audioData,!0),self.source.buffer=self.sourceBuffer,self.source.loop=self.options.looping?!0:!1,self.addNode("panner").addNode("gain");for(var i=0;i<self.options.nodes.length;i++)self.addNode(self.options.nodes[i]);self.nodes.lastnode.connect(self.mix.context.destination)}else self.mix.context.decodeAudioData(self.options.audioData,function(decodedBuffer){log("web audio file decoded",2),self.source=self.mix.context.createBufferSource(),self.sourceBuffer=decodedBuffer,self.source.buffer=self.sourceBuffer,self.source.loop=self.options.looping?!0:!1,self.addNode("panner").addNode("gain");for(var i=0;i<self.options.nodes.length;i++)self.addNode(self.options.nodes[i]);self.nodes.lastnode.connect(self.mix.context.destination)},function(){console.warn("Buggah!")});self.options.muted&&(self.options.gain=0),self.gain(self.options.gain),this.options.gainCache=this.gain(),self.pan(self.options.pan),self.options.startTime=self.source.context.currentTime-self.options.cachedTime;var startFrom=self.options.cachedTime||0;log('[Mixer] Playing track "'+self.name+'" from '+startFrom+" ("+self.options.startTime+")",1),Detect.browser.ios===!0?self.source.noteOn(startFrom):"function"==typeof self.source.start?self.source.start(0,startFrom):self.source.noteOn(startFrom),self.ready=!0,self.trigger("ready");var timer_duration=this.source.buffer.duration-startFrom;self.options.onendtimer=setTimeout(function(){self.options.looping||self.stop(),self.trigger("ended")},1e3*timer_duration),self.ready=!0,self.trigger("ready")}else log('[Mixer] Playing track "'+self.name+'" >',1),self.options.muted&&(self.options.gain=0),self.gain(self.options.gain),this.options.gainCache=this.gain(),self.ready=!0,self.element.play();self.trigger("play")}},Track.prototype.pause=function(at){if(this.ready&&this.playing){var self=this,doIt=function(){self.options.cachedTime="number"==typeof at?at:self.currentTime(),self.playing=!1,self.options.onendtimer&&clearTimeout(self.options.onendtimer),Detect.webAudio===!0?"function"==typeof self.source.stop?self.source.stop(0):"function"==typeof self.source.noteOff&&self.source.noteOff(0):self.element.pause(),log('[Mixer] Pausing track "'+self.name+'" at '+self.options.cachedTime,1),self.trigger("pause",self),at||(self.options.gain=self.options.gainCache)};doIt()}},Track.prototype.stop=function(){if(this.ready&&this.playing){var self=this,doIt=function(){self.playing=!1,self.options.cachedTime=self.options.startTime=0,Detect.webAudio===!0?("function"==typeof self.source.noteOff?self.source.noteOff(0):"function"==typeof self.source.stop&&self.source.stop(0),self.source.context.currentTime=0):(self.options.autoplay=!1,self.element.pause(),self.element.currentTime=0),log('[Mixer] Stopping track "'+self.name+'"',1),self.trigger("stop",self),self.options.gain=self.options.gainCache};Detect.tween?this.tweenGain(0,100,function(){doIt()}):doIt()}},Track.prototype.pan=function(angle_deg){if(Detect.webAudio&&this.ready){if("string"==typeof angle_deg&&("front"===angle_deg?angle_deg=0:"back"===angle_deg?angle_deg=180:"left"===angle_deg?angle_deg=270:"right"===angle_deg&&(angle_deg=90)),"number"==typeof angle_deg){this.options.pan=angle_deg%360;var angle_rad=.017453292519943295*(-angle_deg+90),x=this.options.panX=Math.cos(angle_rad),y=this.options.panY=Math.sin(angle_rad),z=this.options.panZ=-.5;this.nodes.panner.setPosition(x,y,z),this.trigger("pan",this.options.pan)}return{angle:this.options.pan}}},Track.prototype.tweenPan=function(angle_deg,tweenDuration,callback){if(Detect.tween&&Detect.webAudio&&this.ready&&"number"==typeof angle_deg&&"number"==typeof tweenDuration){var self=this;log('[Mixer] "'+self.name+'" tweening pan2d',2);{new TWEEN.Tween({currentAngle:self.options.pan}).to({currentAngle:angle_deg},tweenDuration).easing(TWEEN.Easing.Sinusoidal.InOut).onUpdate(function(){self.pan(this.currentAngle)}).onComplete(function(){"function"==typeof callback&&callback()}).start()}return!0}},Track.prototype.gainCache=function(setTo){return"undefined"!=typeof setTo&&(this.options.gainCache=setTo),this.options.gainCache||0},Track.prototype.gain=function(val){return"number"==typeof val&&(this.options.gain=constrain(val,0,1),this.playing&&!this.options.muted&&(Detect.webAudio?this.nodes.gain.gain.value=this.options.gain*this.mix.gain:this.element.volume=this.options.gain*this.mix.gain),this.trigger("gain",this.options.gain)),this.options.gain},Track.prototype.tweenGain=function(val,tweenDuration,callback){if(!Detect.tween)return this.gain(val),void(callback&&"function"==typeof callback&&callback());if("number"==typeof val&&"number"==typeof tweenDuration){var self=this;log('[Mixer] "'+self.name+'" tweening gain '+self.options.gain+" -> "+val,1);{new TWEEN.Tween({currentGain:self.options.gain}).to({currentGain:val},tweenDuration).easing(TWEEN.Easing.Sinusoidal.InOut).onUpdate(function(){self.gain(this.currentGain)}).onComplete(function(){callback&&"function"==typeof callback&&callback()}).start()}}},Track.prototype.mute=function(){var self=this;self.gainCache(self.options.gain),self.tweenGain(0,500,function(){self.options.muted=!0})},Track.prototype.unmute=function(){this.options.muted=!1,this.tweenGain(this.options.gainCache,500)},Track.prototype.currentTime=function(setTo){return this.ready?("number"==typeof setTo&&(Detect.webAudio?this.playing?(this.pause(setTo),this.play()):this.options.cachedTime=setTo:this.element.currentTime=setTo),this.playing?Detect.webAudio?this.source.context.currentTime-this.options.startTime:this.element.currentTime:this.options.cachedTime||0):void 0},Track.prototype.formattedTime=function(){if(this.ready){var duration=this.duration(),currentTime=this.currentTime();return timeFormat(currentTime)+"/"+timeFormat(duration)}},Track.prototype.duration=function(){return this.ready?Detect.webAudio?this.source.buffer.duration:this.element.duration:void 0},{Mix:Mix}});