define(["tween"],function(){var Mix,Track,Detect,debug=1,constrain=function(val,min,max){return min>val?min:val>max?max:val},log=function(msg,lvl){debug>=lvl&&console.log(msg)};return Detect={audioElement:!!document.createElement("audio").canPlayType,videoElement:!!document.createElement("video").canPlayType,webAudio:!(!window.webkitAudioContext&&!window.AudioContext),nodes:function(){var context=window.AudioContext?new AudioContext:new webkitAudioContext;return{gain:!("function"!=typeof context.createGain),gainNode:!("function"!=typeof context.createGainNode),panner:!("function"!=typeof context.createPanner),convolver:!("function"!=typeof context.createConvolver),delay:!("function"!=typeof context.createDelay),delayNode:!("function"!=typeof context.createDelayNode),compressor:!("function"!=typeof context.createDynamicsCompressor)}}(),audioType:function(){var el=document.createElement("audio"),extension=!1;return extension=el.canPlayType&&el.canPlayType('audio/mp4; codecs="mp4a.40.2"').replace(/no/,"")?".m4a":el.canPlayType&&el.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")?".ogg":el.canPlayType&&el.canPlayType("audio/mpeg;").replace(/no/,"")?".mp3":!1,el=null,extension}(),videoType:function(){var el=document.createElement("video"),extension=!1;return extension=el.canPlayType&&el.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/no/,"")?".webm":el.canPlayType&&el.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"').replace(/no/,"")?".mp4":el.canPlayType&&el.canPlayType('video/ogg; codecs="theora"').replace(/no/,"")?".ogv":!1,el=null,extension}(),browser:{iOS:navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1,Android:navigator.userAgent.match(/Android/g)?!0:!1,Firefox:navigator.userAgent.match(/Firefox/g)?!0:!1,MSIE:navigator.userAgent.match(/MSIE/g)?!0:!1},tween:!!TWEEN},Mix=function(){log("[Mixer] Loaded",1),this.tracks=[],this.lookup={},this.playing=!1,this.muted=!1,this.gain=1,this.events={},this.context=null,this.detect=Detect,Detect.browser.Firefox&&(Detect.webAudio=!1),Detect.webAudio===!0?(log("[Mixer] Web Audio Supported",1),this.context="function"==typeof AudioContext?new AudioContext:new webkitAudioContext):log("[Mixer] no Web Audio, falling back to HTML5",1)},Mix.prototype.getTrack=function(name){return this.lookup[name]||!1},Mix.prototype.createTrack=function(name,opts){if(this.lookup[name])return void console.warn('[Mixer] A track called "'+name+'" already exists');var track=new Track(name,opts,this);return this.tracks.push(track),this.lookup[name]=track,this.muted&&track.mute(),track},Mix.prototype.removeTrack=function(name){var self=this,track=self.lookup[name];if(!track)return void console.warn('[Mixer] can’t remove "'+name+'", it doesn’t exist');var doIt=function(){track.pause();for(var rest,arr=self.tracks,total=arr.length,i=0;total>i;i++)arr[i]&&arr[i].name==name&&(rest=arr.slice(i+1||total),arr.length=0>i?total+i:i,arr.push.apply(arr,rest));track.trigger("remove"),track.events=[],track=null,delete self.lookup[name],log('[Mixer] Removed track "'+name+'"',1)};Detect.tween?track.tweenGain(0,100,doIt):doIt()},Mix.prototype.getTracks=function(group){if("undefined"==typeof group)return this.tracks;for(var tracks=[],i=this.tracks.length-1;i>=0;i--)this.tracks[i].options.group===group&&tracks.push(this.tracks[i]);return tracks},Mix.prototype.removeAll=function(group){var tracks=this.getTracks(group),total=tracks.length;"undefined"==typeof group?(this.playing=!1,log("[Mixer] Removing all "+total+" track(s)",1)):log("[Mixer] Removing "+total+" track(s) from group "+group,1);for(var i=0;total>i;i++)this.removeTrack(tracks[i].name)},Mix.prototype.pause=function(group){var tracks=this.getTracks(group),total=tracks.length;log("[Mixer] Pausing "+total+" track(s) ||",1),this.playing=!1;for(var i=0;total>i;i++)tracks[i].ready&&tracks[i].pause()},Mix.prototype.play=function(group){var tracks=this.getTracks(group),total=tracks.length;log("[Mixer] Playing "+total+" track(s) >",1),this.playing=!0;for(var i=0;total>i;i++)tracks[i].ready&&tracks[i].play()},Mix.prototype.stop=function(group){var tracks=this.getTracks(group),total=tracks.length;log("[Mixer] Stopping "+total+" track(s) .",1),this.playing=!0;for(var i=0;total>i;i++)tracks[i].ready&&tracks[i].stop()},Mix.prototype.mute=function(){if(this.muted===!0)return void this.unmute();var total=this.tracks.length;log("[Mixer] Muting all "+total+" tracks",1),this.playing=!1,this.muted=!0;for(var i=0;total>i;i++)this.tracks[i].ready&&this.tracks[i].mute()},Mix.prototype.unmute=function(){var total=this.tracks.length;log("[Mixer] Unmuting all "+total+" tracks",1),this.playing=!0,this.muted=!1;for(var i=0;total>i;i++)this.tracks[i].ready&&this.tracks[i].unmute()},Mix.prototype.setGain=function(masterGain){if("undefined"!=typeof masterGain){var total=this.tracks.length;this.gain=masterGain;for(var i=0;total>i;i++)this.tracks[i].gain(this.tracks[i].gain())}return this.gain},Mix.prototype.createTrackZero=function(name,opts){var track=new Track(name,opts,this);return this.tracks[0]=track,this.lookup[name]=track,track},Mix.prototype.updateTween=function(){TWEEN.update()},Mix.prototype.extend=function(){for(var output={},args=arguments,l=args.length,i=0;l>i;i++)for(var key in args[i])args[i].hasOwnProperty(key)&&(output[key]=args[i][key]);return output},Mix.prototype.on=function(type,callback){this.events[type]=this.events[type]||[],this.events[type].push(callback)},Mix.prototype.off=function(type){this.events[type]=[]},Mix.prototype.trigger=function(type){if(this.events[type])for(var args=Array.prototype.slice.call(arguments,1),i=0,l=this.events[type].length;l>i;i++)"function"==typeof this.events[type][i]&&this.events[type][i].apply(this,args)},Mix.prototype.setLogLvl=function(lvl){debug=constrain(lvl,0,2)},Track=function(name,opts,mix){var defaults={group:"",source:null,nodes:[],gain:0,gainCache:0,pan:0,panX:0,panY:0,panZ:0,start:0,cachedTime:0,startTime:0,looping:!1,autoplay:!0,onendtimer:null,muted:!1};this.options=Mix.prototype.extend.call(this,defaults,opts||{}),this.options.source=this.options.source+Detect.audioType,this.name=name,this.events={},this.ready=!1,this.nodes={gain:void 0,panner:void 0,convolver:void 0,compressor:void 0,delay:void 0},this.mix=mix,this.element=null;return this.options.source?(log('[Mixer] Creating track "'+name,1),log(this.options,2),void(Detect.webAudio?this.loadBuffer(this.options.source):this.loadDOM(this.options.source))):void console.warn('[Mixer] Can’t create track "'+name+'" without a source')},Track.prototype.loadDOM=function(source){log('[Mixer] load DOM "'+source+'"...',2);var self=this;self.element=document.createElement("audio"),self.element.src=source,self.element.addEventListener("canplaythrough",function(){log('[Mixer] canplaythrough "'+source+'"',2),self.ready=!0,self.trigger("load"),self.options.autoplay&&self.play()},!1),this.options.looping&&self.element.addEventListener("ended",function(){self.element.currentTime=0,self.element.play()},!1),self.element.load(),Detect.browser.Firefox&&self.element.play()},Track.prototype.loadBuffer=function(source){var self=this,request=new XMLHttpRequest;request.open("GET",source,!0),request.responseType="arraybuffer",log('[Mixer] load Buffer "'+source+'"...',2),request.onload=function(){log('[Mixer] "'+self.name+'" loaded "'+source+'"',2),self.options.audioData=request.response,self.ready=!0,self.options.autoplay&&self.play(),self.trigger("load")},request.send()},Track.prototype.addNode=function(nodeType){var self=this;return self.nodes.lastnode||(self.nodes.lastnode=self.options.source),Detect.nodes[nodeType]?("gain"===nodeType?(self.nodes.gain=Detect.nodes.gainNode?self.mix.context.createGainNode():self.mix.context.createGain(),self.nodes.lastnode.connect(self.nodes.gain),self.nodes.lastnode=self.nodes.gain):"panner"===nodeType?(Detect.nodes.gainNode?(self.nodes.panner=self.mix.context.createPanner(),self.nodes.panner.panningModel=webkitAudioPannerNode.EQUALPOWER):(self.nodes.panner=self.mix.context.createPanner(),self.nodes.panner.panningModel="equalpower",self.nodes.panner.panningModel="HRTF"),self.nodes.lastnode.connect(self.nodes.panner),self.nodes.lastnode=self.nodes.panner):"convolver"===nodeType?self.nodes.convolver=self.mix.context.createConvolver():"compressor"===nodeType?(self.nodes.compressor=self.mix.context.createDynamicsCompressor(),self.nodes.lastnode.connect(self.nodes.compressor),self.nodes.lastnode=self.nodes.compressor):"delay"===nodeType&&(self.nodes.delay=Detect.nodes.delayNode?self.mix.context.createDelayNode():self.mix.context.createDelay(),self.nodes.delay.delayTime=0,self.nodes.lastnode.connect(self.nodes.delay),self.nodes.lastnode=self.nodes.delay),log("+ addNode "+nodeType,2),self):self},Track.prototype.play=function(){var self=this;if(self.ready&&self.options.playing!==!0){if(self.options.playing=!0,Detect.webAudio){if(self.options.source=self.options.sourceBuffer=null,self.nodes={},"function"==typeof self.mix.context.createGainNode){self.options.source=self.mix.context.createBufferSource(),self.options.sourceBuffer=self.mix.context.createBuffer(self.options.audioData,!0),self.options.source.buffer=self.options.sourceBuffer,self.options.source.loop=self.options.looping?!0:!1,self.addNode("panner").addNode("gain");for(var i=0;i<self.options.nodes.length;i++)self.addNode(self.options.nodes[i]);self.nodes.lastnode.connect(self.mix.context.destination)}else self.mix.context.decodeAudioData(self.options.audioData,function(decodedBuffer){log("web audio file decoded",2),self.options.source=self.mix.context.createBufferSource(),self.options.sourceBuffer=decodedBuffer,self.options.source.buffer=self.options.sourceBuffer,self.options.source.loop=self.options.looping?!0:!1,self.addNode("panner").addNode("gain");for(var i=0;i<self.options.nodes.length;i++)self.addNode(self.options.nodes[i]);self.nodes.lastnode.connect(self.mix.context.destination)},function(){console.warn("Buggah!")});self.gain(self.options.gain),this.options.gainCache=this.gain(),self.pan(self.options.pan),self.options.startTime=self.options.source.context.currentTime-self.options.cachedTime;var startFrom=self.options.cachedTime||0;log('[Mixer] Playing track "'+self.name+'" from '+startFrom+" ("+self.options.startTime+")",1),Detect.browser.iOS?self.options.source.noteOn(self.options.start):"function"==typeof self.options.source.start?self.options.source.start(0,startFrom):self.options.source.noteOn(self.options.start),console.log("duration: %s",this.options.source.buffer.duration);var timer_duration=this.options.source.buffer.duration-startFrom;console.log("timer_duration: %s",timer_duration),self.options.onendtimer=setTimeout(function(){self.options.looping||self.stop(),self.trigger("end")},1e3*timer_duration)}else log('[Mixer] Playing track "'+self.name+'" >',1),self.element.play();self.trigger("play")}},Track.prototype.pause=function(){if(this.ready&&this.options.playing){var self=this,doIt=function(){self.options.cachedTime=self.getCurrentTime(),self.options.playing=!1,self.options.onendtimer&&clearTimeout(self.options.onendtimer),Detect.webAudio?"function"==typeof self.options.source.stop?self.options.source.stop(0):"function"==typeof self.options.source.noteOff&&self.options.source.noteOff(0):self.element.pause(),log('[Mixer] Pausing track "'+self.name+'" at '+self.options.cachedTime,1),self.trigger("pause",self),self.options.gain=self.options.gainCache};Detect.tween?this.tweenGain(0,100,function(){doIt()}):doIt()}},Track.prototype.stop=function(){if(this.ready&&this.options.playing){var self=this,doIt=function(){self.options.playing=!1,self.options.cachedTime=self.options.startTime=0,Detect.webAudio?("function"==typeof self.options.source.noteOff?self.options.source.noteOff(0):"function"==typeof self.options.source.stop&&self.options.source.stop(0),self.options.source.context.currentTime=0):(self.element.pause(),self.element.currentTime=0),log('[Mixer] Stopping track "'+self.name+'"',1),self.trigger("stop",self),self.options.gain=self.options.gainCache};Detect.tween?this.tweenGain(0,100,function(){doIt()}):doIt()}},Track.prototype.pan=function(angle_deg){if(Detect.webAudio&&this.options.playing){if("string"==typeof angle_deg&&("front"===angle_deg?angle_deg=0:"back"===angle_deg?angle_deg=180:"left"===angle_deg?angle_deg=270:"right"===angle_deg&&(angle_deg=90)),"number"==typeof angle_deg){this.options.pan=angle_deg%360;var angle_rad=.017453292519943295*(-angle_deg+90),x=this.options.panX=Math.cos(angle_rad),y=this.options.panY=Math.sin(angle_rad),z=this.options.panZ=-.5;this.nodes.panner.setPosition(x,y,z),this.trigger("pan",this.options.pan)}return{angle:this.options.pan}}},Track.prototype.tweenPan=function(angle_deg,tweenDuration,callback){if(Detect.tween&&Detect.webAudio&&"number"==typeof angle_deg&&"number"==typeof tweenDuration){var self=this;log('[Mixer] "'+self.name+'" tweening pan2d',2);{new TWEEN.Tween({currentAngle:self.options.pan}).to({currentAngle:angle_deg},tweenDuration).easing(TWEEN.Easing.Sinusoidal.InOut).onUpdate(function(){self.pan(this.currentAngle)}).onComplete(function(){"function"==typeof callback&&callback()}).start()}return!0}},Track.prototype.gainCache=function(setTo){return"undefined"!=typeof setTo&&(this.options.gainCache=setTo),this.options.gainCache||0},Track.prototype.gain=function(val){return!this.options.muted&&this.options.playing?("number"==typeof val&&(this.options.gain=constrain(val,0,1),Detect.webAudio?this.nodes.gain.gain.value=this.options.gain*this.mix.gain:this.element.volume=this.options.gain*this.mix.gain,this.trigger("gain",this.options.gain)),this.options.gain):void 0},Track.prototype.tweenGain=function(val,tweenDuration,callback){if(Detect.tween&&this.options.muted!==!0&&"number"==typeof val&&"number"==typeof tweenDuration){var self=this;log('[Mixer] "'+self.name+'" tweening gain '+self.options.gain+" -> "+val,2);{new TWEEN.Tween({currentGain:self.options.gain}).to({currentGain:val},tweenDuration).easing(TWEEN.Easing.Sinusoidal.InOut).onUpdate(function(){self.gain(this.currentGain)}).onComplete(function(){"function"==typeof callback&&callback()}).start()}}},Track.prototype.mute=function(){var self=this;return self.options.muted===!0?void self.unmute():(self.gainCache(self.options.gain),void self.tweenGain(0,500,function(){self.options.muted=!0}))},Track.prototype.unmute=function(){this.options.muted=!1,this.tweenGain(this.options.gainCache,500)},Track.prototype.getCurrentTime=function(){return this.ready?this.options.playing?Detect.webAudio?this.options.source.context.currentTime-this.options.startTime:this.element.currentTime:this.options.cachedTime||0:void 0},Track.prototype.getDuration=function(){return this.ready?Detect.webAudio?this.options.source.buffer.duration:this.options.element.duration:void 0},Track.prototype.on=function(type,callback){this.events[type]=this.events[type]||[],this.events[type].push(callback)},Track.prototype.off=function(type){this.events[type]=[]},Track.prototype.trigger=function(type){if(this.events[type]){log(arguments,2);for(var args=Array.prototype.slice.call(arguments,1),i=0,l=this.events[type].length;l>i;i++)"function"==typeof this.events[type][i]&&this.events[type][i].apply(this,args)}},{Mix:Mix}});